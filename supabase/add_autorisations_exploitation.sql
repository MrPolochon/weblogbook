-- ============================================================
-- AUTORISATIONS D'EXPLOITATION
-- Les PDG doivent demander une autorisation auprès de l'IFSA
-- pour exploiter chaque type d'avion. Sans autorisation approuvée,
-- la compagnie ne peut pas acheter ce type d'avion.
-- ============================================================

CREATE TABLE IF NOT EXISTS public.autorisations_exploitation (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  compagnie_id UUID NOT NULL REFERENCES public.compagnies(id) ON DELETE CASCADE,
  type_avion_id UUID NOT NULL REFERENCES public.types_avion(id) ON DELETE CASCADE,
  demandeur_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,

  -- Statut de la demande
  statut TEXT NOT NULL DEFAULT 'en_attente'
    CHECK (statut IN ('en_attente', 'approuvee', 'refusee', 'revoquee')),

  -- Numéro de document (format: AE-YYYY-####)
  numero_document TEXT UNIQUE,

  -- Motif de la demande par le PDG
  motif_demande TEXT,

  -- Réponse de l'agent IFSA
  motif_reponse TEXT,
  traite_par_id UUID REFERENCES public.profiles(id) ON DELETE SET NULL,
  traite_at TIMESTAMPTZ,

  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now(),

  UNIQUE(compagnie_id, type_avion_id, statut)
);

-- Retirer la contrainte UNIQUE problématique (plusieurs refusées possibles)
-- On la remplace par un index partiel sur les demandes actives uniquement
ALTER TABLE public.autorisations_exploitation DROP CONSTRAINT IF EXISTS autorisations_exploitation_compagnie_id_type_avion_id_statut_key;

CREATE UNIQUE INDEX IF NOT EXISTS idx_autorisations_exploitation_active
  ON public.autorisations_exploitation(compagnie_id, type_avion_id)
  WHERE statut IN ('en_attente', 'approuvee');

CREATE INDEX IF NOT EXISTS idx_autorisations_exploitation_compagnie
  ON public.autorisations_exploitation(compagnie_id);

CREATE INDEX IF NOT EXISTS idx_autorisations_exploitation_statut
  ON public.autorisations_exploitation(statut)
  WHERE statut = 'en_attente';

CREATE INDEX IF NOT EXISTS idx_autorisations_exploitation_type_avion
  ON public.autorisations_exploitation(type_avion_id);

-- Fonction pour générer le numéro de document
CREATE OR REPLACE FUNCTION public.generer_numero_autorisation()
RETURNS TRIGGER AS $$
DECLARE
  annee TEXT;
  prochain_num INTEGER;
BEGIN
  annee := to_char(now(), 'YYYY');
  SELECT COALESCE(MAX(
    CAST(SUBSTRING(numero_document FROM 'AE-' || annee || '-(\d+)') AS INTEGER)
  ), 0) + 1
  INTO prochain_num
  FROM public.autorisations_exploitation
  WHERE numero_document LIKE 'AE-' || annee || '-%';

  NEW.numero_document := 'AE-' || annee || '-' || LPAD(prochain_num::TEXT, 4, '0');
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_generer_numero_autorisation ON public.autorisations_exploitation;
CREATE TRIGGER trg_generer_numero_autorisation
  BEFORE INSERT ON public.autorisations_exploitation
  FOR EACH ROW
  EXECUTE FUNCTION public.generer_numero_autorisation();

-- Trigger updated_at
CREATE OR REPLACE FUNCTION public.update_autorisations_exploitation_updated_at()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = now();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DROP TRIGGER IF EXISTS trg_autorisations_exploitation_updated_at ON public.autorisations_exploitation;
CREATE TRIGGER trg_autorisations_exploitation_updated_at
  BEFORE UPDATE ON public.autorisations_exploitation
  FOR EACH ROW
  EXECUTE FUNCTION public.update_autorisations_exploitation_updated_at();

-- RLS
ALTER TABLE public.autorisations_exploitation ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Les admins peuvent tout voir"
  ON public.autorisations_exploitation FOR ALL
  USING (public.is_admin());

CREATE POLICY "Les agents IFSA peuvent tout voir"
  ON public.autorisations_exploitation FOR SELECT
  USING (EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND ifsa = true));

CREATE POLICY "Les agents IFSA peuvent modifier"
  ON public.autorisations_exploitation FOR UPDATE
  USING (EXISTS (SELECT 1 FROM public.profiles WHERE id = auth.uid() AND ifsa = true));

CREATE POLICY "Les PDG voient les autorisations de leur compagnie"
  ON public.autorisations_exploitation FOR SELECT
  USING (compagnie_id IN (SELECT id FROM public.compagnies WHERE pdg_id = auth.uid()));

CREATE POLICY "Les PDG peuvent créer des demandes"
  ON public.autorisations_exploitation FOR INSERT
  WITH CHECK (compagnie_id IN (SELECT id FROM public.compagnies WHERE pdg_id = auth.uid()));

CREATE POLICY "Les employés voient les autorisations de leur compagnie"
  ON public.autorisations_exploitation FOR SELECT
  USING (compagnie_id IN (SELECT compagnie_id FROM public.compagnie_employes WHERE pilote_id = auth.uid()));

-- Commentaires
COMMENT ON TABLE public.autorisations_exploitation IS 'Demandes d''autorisation d''exploitation de types d''avion par les compagnies, traitées par l''IFSA';
COMMENT ON COLUMN public.autorisations_exploitation.statut IS 'en_attente = demande en cours, approuvee = autorisée, refusee = refusée, revoquee = révoquée par IFSA';
COMMENT ON COLUMN public.autorisations_exploitation.numero_document IS 'Numéro unique du document d''autorisation (AE-YYYY-####)';
