import { NextResponse, NextRequest } from 'next/server';
import { createClient } from '@/lib/supabase/server';
import { createAdminClient } from '@/lib/supabase/admin';

// GET - Liste des autorisations d'exploitation
export async function GET(req: NextRequest) {
  try {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return NextResponse.json({ error: 'Non authentifié' }, { status: 401 });

    const { searchParams } = new URL(req.url);
    const compagnieId = searchParams.get('compagnie_id');
    const statut = searchParams.get('statut');
    const toutes = searchParams.get('toutes') === 'true';

    const admin = createAdminClient();

    const { data: profile } = await admin.from('profiles')
      .select('role, ifsa')
      .eq('id', user.id)
      .single();

    let query = admin.from('autorisations_exploitation')
      .select(`
        *,
        compagnie:compagnie_id(id, nom),
        type_avion:type_avion_id(id, nom, code_oaci, constructeur),
        demandeur:demandeur_id(id, identifiant),
        traite_par:traite_par_id(id, identifiant)
      `)
      .order('created_at', { ascending: false });

    if (toutes && (profile?.ifsa || profile?.role === 'admin')) {
      // IFSA/admin : toutes les demandes
      if (statut) {
        query = query.eq('statut', statut);
      }
    } else if (compagnieId) {
      query = query.eq('compagnie_id', compagnieId);
    } else {
      return NextResponse.json({ error: 'compagnie_id requis' }, { status: 400 });
    }

    const { data, error } = await query;
    if (error) return NextResponse.json({ error: error.message }, { status: 400 });

    return NextResponse.json(data || []);
  } catch (e) {
    console.error('Autorisations GET:', e);
    return NextResponse.json({ error: 'Erreur serveur' }, { status: 500 });
  }
}

// POST - Créer une demande d'autorisation
export async function POST(req: NextRequest) {
  try {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return NextResponse.json({ error: 'Non authentifié' }, { status: 401 });

    const body = await req.json();
    const { compagnie_id, type_avion_id, motif_demande } = body;

    if (!compagnie_id || !type_avion_id) {
      return NextResponse.json({ error: 'compagnie_id et type_avion_id requis' }, { status: 400 });
    }

    const admin = createAdminClient();

    // Vérifier que l'utilisateur est PDG de la compagnie
    const { data: compagnie } = await admin.from('compagnies')
      .select('id, pdg_id, nom')
      .eq('id', compagnie_id)
      .single();

    if (!compagnie || compagnie.pdg_id !== user.id) {
      return NextResponse.json({ error: 'Seul le PDG peut demander une autorisation d\'exploitation' }, { status: 403 });
    }

    // Vérifier que le type d'avion existe
    const { data: typeAvion } = await admin.from('types_avion')
      .select('id, nom')
      .eq('id', type_avion_id)
      .single();

    if (!typeAvion) {
      return NextResponse.json({ error: 'Type d\'avion introuvable' }, { status: 404 });
    }

    // Vérifier qu'il n'y a pas déjà une demande active (en_attente ou approuvee)
    const { data: existante } = await admin.from('autorisations_exploitation')
      .select('id, statut')
      .eq('compagnie_id', compagnie_id)
      .eq('type_avion_id', type_avion_id)
      .in('statut', ['en_attente', 'approuvee'])
      .maybeSingle();

    if (existante) {
      if (existante.statut === 'approuvee') {
        return NextResponse.json({ error: `Vous avez déjà une autorisation approuvée pour le ${typeAvion.nom}` }, { status: 400 });
      }
      return NextResponse.json({ error: `Une demande est déjà en attente pour le ${typeAvion.nom}` }, { status: 400 });
    }

    const { data: autorisation, error } = await admin.from('autorisations_exploitation')
      .insert({
        compagnie_id,
        type_avion_id,
        demandeur_id: user.id,
        motif_demande: motif_demande || null,
        statut: 'en_attente'
      })
      .select('id, numero_document')
      .single();

    if (error) {
      console.error('Erreur création autorisation:', error);
      return NextResponse.json({ error: error.message }, { status: 400 });
    }

    return NextResponse.json({
      ok: true,
      id: autorisation.id,
      numero_document: autorisation.numero_document,
      message: `Demande d'autorisation ${autorisation.numero_document} créée pour ${typeAvion.nom}`
    });
  } catch (e) {
    console.error('Autorisations POST:', e);
    return NextResponse.json({ error: 'Erreur serveur' }, { status: 500 });
  }
}

// PATCH - Traiter une demande (IFSA/admin) ou révoquer
export async function PATCH(req: NextRequest) {
  try {
    const supabase = await createClient();
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return NextResponse.json({ error: 'Non authentifié' }, { status: 401 });

    const body = await req.json();
    const { id, action, motif_reponse } = body;

    if (!id || !action) {
      return NextResponse.json({ error: 'id et action requis' }, { status: 400 });
    }

    if (!['approuver', 'refuser', 'revoquer'].includes(action)) {
      return NextResponse.json({ error: 'Action invalide' }, { status: 400 });
    }

    const admin = createAdminClient();

    // Vérifier que l'utilisateur est IFSA ou admin
    const { data: profile } = await admin.from('profiles')
      .select('role, ifsa')
      .eq('id', user.id)
      .single();

    if (!profile?.ifsa && profile?.role !== 'admin') {
      return NextResponse.json({ error: 'Seuls les agents IFSA peuvent traiter les demandes' }, { status: 403 });
    }

    // Récupérer la demande
    const { data: autorisation } = await admin.from('autorisations_exploitation')
      .select('*, type_avion:type_avion_id(nom), compagnie:compagnie_id(nom)')
      .eq('id', id)
      .single();

    if (!autorisation) {
      return NextResponse.json({ error: 'Demande introuvable' }, { status: 404 });
    }

    let nouveauStatut: string;

    if (action === 'approuver') {
      if (autorisation.statut !== 'en_attente') {
        return NextResponse.json({ error: 'Seules les demandes en attente peuvent être approuvées' }, { status: 400 });
      }
      nouveauStatut = 'approuvee';
    } else if (action === 'refuser') {
      if (autorisation.statut !== 'en_attente') {
        return NextResponse.json({ error: 'Seules les demandes en attente peuvent être refusées' }, { status: 400 });
      }
      nouveauStatut = 'refusee';
    } else {
      // revoquer
      if (autorisation.statut !== 'approuvee') {
        return NextResponse.json({ error: 'Seules les autorisations approuvées peuvent être révoquées' }, { status: 400 });
      }
      nouveauStatut = 'revoquee';
    }

    const { error } = await admin.from('autorisations_exploitation')
      .update({
        statut: nouveauStatut,
        motif_reponse: motif_reponse || null,
        traite_par_id: user.id,
        traite_at: new Date().toISOString()
      })
      .eq('id', id);

    if (error) {
      console.error('Erreur traitement autorisation:', error);
      return NextResponse.json({ error: error.message }, { status: 400 });
    }

    const typeAvionObj = autorisation.type_avion as { nom: string } | null;
    const compagnieObj = autorisation.compagnie as { nom: string } | null;
    const actionLabel = action === 'approuver' ? 'approuvée' : action === 'refuser' ? 'refusée' : 'révoquée';

    return NextResponse.json({
      ok: true,
      message: `Autorisation ${autorisation.numero_document} ${actionLabel} (${typeAvionObj?.nom || 'Avion'} - ${compagnieObj?.nom || 'Compagnie'})`
    });
  } catch (e) {
    console.error('Autorisations PATCH:', e);
    return NextResponse.json({ error: 'Erreur serveur' }, { status: 500 });
  }
}
